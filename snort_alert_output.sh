#!/usr/bin/env bash

# Loops through a directory looking for pcaps and outputs and alert.log file for each pcap with a date and timestamp

dir="$1"
output_dir="$2"
logoutput=snort-alerts.txt
priority1alert=priority1-alerts.txt
priority2alert=priority2-alerts.txt
priority3alert=priority3-alerts.txt

if [[ ! -d "$dir" ]] || [[ ! -d "$output_dir" ]]; then
    printf '%s %s %s %s\n' 'Usage:' "$(basename "$0")" 'location of pcaps' 'location to output logfile'
    printf '%s\n' 'Searches a pcap file for snort alerts'
    exit 0
fi

function alert_output() {
   while read -r; do
        printf '%s %s %s %s\n' 'Reading network traffic from' "$REPLY" 'Time Started:' "$(date +'%D %T')"
        printf '%s\n\n' "################################"
 	sudo /sbin/snort -A console -r "$REPLY" --pcap-reset -c /etc/snort/snort.conf -U  --daq pcap --daq-mode read-file -q
        printf '%s\n\n' "################################"
        printf '%s %s\n' 'Time Finished:' "$(date +'%D %T')"
   done < <(find "$dir" -type f -iname '*.pcap') | tee -a "${output_dir}$logoutput"
        echo "You may view the alert log at ${output_dir}$logoutput"
}

function priority_one_alerts() {
        sed -e '/\[Priority: [23]\]/d' "${output_dir}$logoutput" > "${output_dir}$priority1alert"
        echo "Your may view the priority 1 alerts at ${output_dir}$priority1alert"
}

function priority_two_alerts() {
        sed -e '/\[Priority: [13]\]/d' "${output_dir}$logoutput" > "${output_dir}$priority2alert"
        echo "You may view the priority 2 alerts at ${output_dir}$priority2alert"
}

function priority_three_alerts() {
        sed -e '/\[Priority: [12]\]/d' "${output_dir}$logoutput" > "${output_dir}$priority3alert"
        echo "You may view the priority 3 alerts at ${output_dir}$priority3alert"
}

function main {
    alert_output "$dir" "$output_dir"
    priority_one_alerts "$output_dir"
    priority_two_alerts "$output_dir"
    priority_three_alerts "$output_dir"
}

main
